name: CI/CD Pipeline - Medhelper

on:
   push:
      branches:
         - main
   pull_request:
      branches:
         - main

jobs:
   deploy:
      runs-on: ubuntu-latest

      steps:
         - name: Setup SSH Key
           run: |
              mkdir -p ~/.ssh
              echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
              chmod 400 ~/.ssh/id_rsa
              ssh-keyscan -H "${{ secrets.HOST_IP }}" >> ~/.ssh/known_hosts
           shell: bash

         - name: Debug SSH Connection
           run: |
              ls -l ~/.ssh/
              head -n 2 ~/.ssh/id_rsa
              ssh -v -i ~/.ssh/id_rsa "${{ secrets.USER }}@${{ secrets.HOST_IP }}" whoami
           shell: bash
           continue-on-error: true # Allows pipeline to continue even if debug fails

         - name: Connect to GCP and Deploy
           run: |
              ssh -i ~/.ssh/id_rsa "${{ secrets.USER }}@${{ secrets.HOST_IP }}" << 'EOF'
                cd /home/${{ secrets.USER }}
                echo "success connected"
                docker-compose down medhelper
                cd dev-medhelper
                git pull origin main
                docker-compose build medhelper
                docker-compose up -d medhelper
                docker image prune -af
              EOF
           shell: bash
