name: CI/CD Pipeline - Medhelper

on:
   push:
      branches:
         - main
   pull_request:
      branches:
         - main

jobs:
   deploy:
      runs-on: ubuntu-latest

      steps:
         - name: Setup SSH Key
           run: |
              mkdir -p ~/.ssh
              echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
              chmod 400 ~/.ssh/id_rsa
              ssh-keyscan -H 34.28.117.95 >> ~/.ssh/known_hosts
           shell: bash

         - name: Connect to GCP and Deploy
           run: |
              ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa sukhbatsuugii2004@34.28.117.95 << 'EOF'
                cd /home/sukhbatsuugii2004/dev-medhelper
                echo "success connected"
                docker compose down 
                git pull origin main
                docker compose up -d --build
                docker image prune -af
              EOF
           shell: bash
